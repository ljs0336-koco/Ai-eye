<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ë°€ ì•½ ë´‰íˆ¬ ë¦¬ë”ê¸°</title>
    <!-- Tesseract v4 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <style>
        body {
            background-color: #000;
            color: #FFD700;
            margin: 0;
            font-family: 'Pretendard', sans-serif;
            overflow: hidden;
        }

        .cam-container {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1;
        }

        video {
            width: 100%; height: 100%;
            object-fit: cover;
            /* ëŒ€ë¹„ë¥¼ ë†’ì—¬ì„œ ê¸€ì ê²½ê³„ë¥¼ ëšœë ·í•˜ê²Œ */
            filter: contrast(1.2) brightness(1.1);
        }

        #result-overlay {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.9);
            border-top: 6px solid #FFD700;
            z-index: 100;
            text-align: center;
        }

        #detected-text {
            font-size: 3rem;
            font-weight: 900;
            color: #FFD700;
            margin-bottom: 5px;
        }

        #debug-msg {
            font-size: 1rem;
            color: #666; /* ì¸ì‹ëœ ì‹¤ì œ í…ìŠ¤íŠ¸ë¥¼ ì‘ê²Œ ë³´ì—¬ì¤Œ */
            margin-bottom: 10px;
            height: 1.2rem;
            overflow: hidden;
        }

        #start-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .big-icon { font-size: 80px; margin-bottom: 20px; }
        .btn-text { font-size: 24px; font-weight: bold; color: #FFD700; }
        .loading-text { color: #888; margin-top: 10px; font-size: 14px;}

    </style>
</head>
<body>

    <div id="start-screen" onclick="initApp()">
        <div class="big-icon">ğŸ’Š</div>
        <div class="btn-text" id="btn-text">ë¡œë”© ì¤‘...</div>
        <div class="loading-text" id="status-log">ì—”ì§„ ì¤€ë¹„ ì¤‘</div>
    </div>

    <div class="cam-container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="proc-canvas" style="display:none;"></canvas>
    </div>

    <div id="result-overlay">
        <div id="detected-text">ëŒ€ê¸° ì¤‘</div>
        <div id="debug-msg"></div> <!-- ì˜¤íƒ€ê°€ ì–´ë–»ê²Œ ë‚˜ëŠ”ì§€ í™•ì¸ìš© -->
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('proc-canvas');
        const ctx = canvas.getContext('2d');
        const resultDiv = document.getElementById('detected-text');
        const debugDiv = document.getElementById('debug-msg');
        const startScreen = document.getElementById('start-screen');
        const btnText = document.getElementById('btn-text');
        const statusLog = document.getElementById('status-log');

        let worker = null;
        let isReady = false;
        let isProcessing = false;
        let lastSpeakTime = 0;

        // 1. Tesseract ì´ˆê¸°í™” (ì •ë°€ ì„¤ì •)
        (async () => {
            worker = await Tesseract.createWorker({
                logger: m => {
                    if(m.status === 'initialized tesseract') statusLog.innerText = "ì„¤ì • ì ìš© ì¤‘...";
                }
            });
            
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            
            // â˜… ì¤‘ìš” ìˆ˜ì •: ìˆ«ìë„ í—ˆìš© (Oë¥¼ 0ìœ¼ë¡œ ì¸ì‹í•˜ëŠ” ê²½ìš° ëŒ€ë¹„)
            await worker.setParameters({
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
                // í˜ì´ì§€ ë¶„í•  ëª¨ë“œ: í©ì–´ì§„ í…ìŠ¤íŠ¸(Sparse Text) ì¸ì‹ì— ìµœì í™” (ëª¨ë“œ 11 ë˜ëŠ” 12)
                tessedit_pageseg_mode: '11', 
            });

            isReady = true;
            btnText.innerText = "í™”ë©´ì„ ëˆŒëŸ¬ ì‹œì‘";
            statusLog.innerText = "ì¤€ë¹„ ì™„ë£Œ";
        })();

        function initApp() {
            if(!isReady) return;
            startScreen.style.display = 'none';
            speak("ì•½ êµ¬ë¶„ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
            startCamera();
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    requestAnimationFrame(scanLoop);
                };
            } catch (err) {
                alert("ì¹´ë©”ë¼ ì˜¤ë¥˜");
            }
        }

        async function scanLoop() {
            if (isReady && !isProcessing) {
                await processFrame();
            }
            requestAnimationFrame(scanLoop); // ì‰¼ ì—†ì´ ê³„ì† ê°ì‹œ
        }

        async function processFrame() {
            isProcessing = true;
            try {
                // ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ë„ˆë¬´ ì¤„ì´ë©´ ì‘ì€ ê¸€ì”¨(COLD)ê°€ ë­‰ê°œì§. 
                // ê°€ë¡œ 800px ì •ë„ë¡œ ì‚´ì§ í‚¤ì›€.
                const scale = 800 / video.videoWidth; 
                canvas.width = 800;
                canvas.height = video.videoHeight * scale;

                // í‘ë°± + ëŒ€ë¹„ ê·¹ëŒ€í™” (ê¸€ì ì„ ëª…í•˜ê²Œ)
                ctx.filter = 'grayscale(100%) contrast(200%)'; 
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.filter = 'none';

                const { data: { text } } = await worker.recognize(canvas);
                
                // íŠ¹ìˆ˜ë¬¸ì/ê³µë°± ì œê±° í›„ ëŒ€ë¬¸ì
                const cleanText = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // ë””ë²„ê¹…ìš© (ì‹¤ì œë¡œ ì–´ë–»ê²Œ ì½ê³  ìˆëŠ”ì§€ í™”ë©´ì— í‘œì‹œ)
                if(cleanText.length > 0) debugDiv.innerText = "ì¸ì‹ë¨: " + cleanText.substring(0, 20) + "...";

                smartMatch(cleanText);

            } catch (e) {
                console.error(e);
            } finally {
                isProcessing = false;
            }
        }

        // â˜… í•µì‹¬ ì•Œê³ ë¦¬ì¦˜: ì˜¤íƒ€ê°€ ë‚˜ë„ ì•Œì•„ë“£ëŠ” 'ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­'
        function smartMatch(text) {
            const now = Date.now();
            if (now - lastSpeakTime < 2500) return;

            let name = "";
            let msg = "";

            // ì •ê·œí‘œí˜„ì‹(Regex)ì„ ì‚¬ìš©í•œ ìœ ì—°í•œ ê²€ì‚¬
            
            // 1. COLD (ê°ê¸°ì•½)
            // C ë‹¤ìŒì— O ë˜ëŠ” 0(ìˆ«ì) ë˜ëŠ” D,Qê°€ ì˜¤ê³ , L ë˜ëŠ” 1,Iê°€ ì˜¤ê³  Dê°€ ì˜¤ëŠ” íŒ¨í„´
            // ì˜ˆ: COLD, C0LD, CQ1D, CO1D ë“±
            const coldRegex = /C[O0DQ][L1I]D/; 
            
            // 2. ASPIRIN (ë‘í†µì•½) - ì´ë¯¸ ì˜ ë˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜
            const aspirinRegex = /ASP[1I]R/;

            // 3. TYLENOL
            const tylenolRegex = /TYL/;

            // 4. VITAMIN
            const vitaRegex = /V[1I]TA/;

            if (coldRegex.test(text)) {
                name = "ê°ê¸°ì•½";
                msg = "ê°ê¸°ì•½ì…ë‹ˆë‹¤.";
            } 
            else if (aspirinRegex.test(text)) {
                name = "ë‘í†µì•½";
                msg = "ë‘í†µì•½ì…ë‹ˆë‹¤.";
            }
            else if (tylenolRegex.test(text)) {
                name = "ì§„í†µì œ";
                msg = "íƒ€ì´ë ˆë†€ì…ë‹ˆë‹¤.";
            }
            else if (vitaRegex.test(text)) {
                name = "ë¹„íƒ€ë¯¼";
                msg = "ë¹„íƒ€ë¯¼ì…ë‹ˆë‹¤.";
            }

            if (name) {
                resultDiv.innerText = name;
                resultDiv.style.color = "#00FF00"; // ì°¾ìœ¼ë©´ ì´ˆë¡ìƒ‰
                
                if (navigator.vibrate) navigator.vibrate(200);
                speak(msg);
                
                lastSpeakTime = now;
                
                // 1ì´ˆ ë’¤ì— ìƒ‰ìƒ ì›ë³µ
                setTimeout(() => resultDiv.style.color = "#FFD700", 1000);
            }
        }

        function speak(msg) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(msg);
            u.lang = 'ko-KR';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
